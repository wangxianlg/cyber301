import requests
from requests.exceptions import RequestException

import uvicorn
from starlette.applications import Starlette
from starlette.requests import Request
from starlette.routing import Route, Mount

from mcp.server.fastmcp import FastMCP
from mcp.shared.exceptions import McpError
from mcp.types import ErrorData, INTERNAL_ERROR, INVALID_PARAMS
from mcp.server.sse import SseServerTransport
import time
import warnings
import asyncio

# Import Ollama functions for summarization
from ollama import chat, ChatResponse
from ollama import Client
client = Client()

# searches PubMed for article abstracts using BioPython's Entrez module. It leverages the FastMCP framework to provide asynchronous search capabilities for PubMed.
mcp = FastMCP("Vulnerability-Lookup")


@mcp.tool()
async def search_Vulnerability(cve: str = "CVE-2025-59287") -> str:
    """
    Search Vulnerability

    Args:
        query: CVE ID.

    Returns:
        A string containing the vulnerability summary.
    """

    url = f"https://vulnerability.circl.lu/api/cve/{cve}"
    response = requests.get(url)
    vuln_summary = ""
    if response.status_code == 200:
        data = response.json()
        #vuln_summary = vuln_summary + data["cveMetadata"]["cveId"] + " "
        print (data["containers"]["cna"]["descriptions"][0])
        
        for item in data["containers"]["cna"]["descriptions"]: # show results
            vuln_summary = vuln_summary + item['value'] + " "
        #print (vuln_summary)
        return vuln_summary
    else:
        return "Failed to fetch data from CIRCL CVE API."
    


# Set up the SSE transport for MCP communication.
sse = SseServerTransport("/messages/")

async def handle_sse(request: Request) -> None:
    _server = mcp._mcp_server
    async with sse.connect_sse(
        request.scope,
        request.receive,
        request._send,
    ) as (reader, writer):
        await _server.run(reader, writer, _server.create_initialization_options())

# Create the Starlette app with two endpoints:
app = Starlette(
    debug=True,
    routes=[
        Route("/sse", endpoint=handle_sse),
        Mount("/messages/", app=sse.handle_post_message),
    ],
)

if __name__ == "__main__":
    uvicorn.run(app, host="localhost", port=8001)
