import asyncio
import traceback
from mcp import ClientSession
from mcp.client.sse import sse_client
from mcp.types import ReadResourceResult, TextContent, AnyUrl
import json

async def call_vuln_lookup_tool(server_url: str, cve: str) -> str:
    """
    Connects to the MCP server using SSE, initializes the session,
    calls the search_Vulnerability tool, and returns the result.
    """
    try:
        async with sse_client(server_url) as streams:
            async with ClientSession(streams[0], streams[1]) as session:
                await session.initialize()
                result = await session.call_tool("search_Vulnerability", arguments={"cve": cve})
                return result
    except Exception as e:
        return f"Error: {e}\n{traceback.format_exc()}"
    
'''
async def call_vuln_Incident_Response_tool(server_url: str, vuln_Summary: str) -> str:
    """
    Connects to the MCP server using SSE, initializes the session,
    calls the summarize_wikipedia_article tool, and returns the result.
    """
    try:
        async with sse_client(server_url) as streams:
            async with ClientSession(streams[0], streams[1]) as session:
                await session.initialize()
                result = await session.call_tool("Create_Vulnerability_Incident_Response_Plan", arguments={"vuln_summary": vuln_Summary})
                return result
    except Exception as e:
        return f"Error: {e}\n{traceback.format_exc()}"
'''

def main():
    
    vuln_lookup_Server_url = "http://localhost:8001/sse"
    cve =  "CVE-2017-0144"
    
    vuln_Summary_result = asyncio.run(call_vuln_lookup_tool(vuln_lookup_Server_url, cve))
    #print (vuln_Summary_result)
    content_list = vuln_Summary_result.content
    
    text_content= cve + " \n"
    # Iterate through the content list
    for content_item in content_list:
        # Check if the type is 'text'
        if content_item.type == 'text':
            # Access the text attribute directly
            text_content = content_item.text
         
    print(text_content)
    
    '''
    vuln_incident_Response_Server_url = "http://localhost:8002/sse"
    
    vuln_Incident_Response_result = asyncio.run(call_vuln_Incident_Response_tool(vuln_incident_Response_Server_url, text_content))

    print (vuln_Incident_Response_result)
    '''

if __name__ == "__main__":
    main()
